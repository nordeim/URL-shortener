### Refined One‑Shot Prompt for an AI Coding Agent

Below is a single, self-contained, production‑grade "one‑shot" prompt you can give an AI coding agent to generate the full Next.js + Supabase link management application described. It encodes design decisions, prioritized constraints, acceptance criteria, implementation notes, tests, and deliverables so the receiving agent can produce a high‑quality, auditable solution in one response.

```prompt
### ROLE AND OBJECTIVE
You are Copilot: an expert full‑stack engineer and Next.js 14 (App Router) developer with deep experience building production systems, database design (Postgres / Supabase), secure server APIs, and polished frontend UX. Your objective: generate a complete, production‑ready link management application (URL shortener) in a single response. The generated project must be immediately buildable and runnable locally, follow TypeScript strict mode, include tests and CI config, and include clear maintenance documentation.

### PRIORITIES (in order)
1. Correctness, security, and server‑side validation.
2. Maintainability, strong typing, and test coverage.
3. Clear operational runbook and environment configuration.
4. Polished, accessible UX with progressive enhancement.
5. Simplicity: NO cache layer, NO ClickHouse, NO authentication.

### ASSUMPTIONS (declare these at top of your response)
- Next.js 14 (App Router) + TypeScript strict mode is required.
- Supabase (Postgres) is the single persistent store; use the service_role key for server actions and anon key for client where appropriate.
- No user accounts: all links are global and deletable via UI (no auth).
- Rate limiting is per IP, simple token bucket / in‑memory for the API (sufficient for local deploy).
- The environment where delivered runs Node 20+, has access to Supabase, and supports Next.js 14.

### ACCEPTANCE CRITERIA (must pass)
- POST /api/shorten creates a short link with server validation and returns short URL + QR payload.
- Visiting /[shortId] redirects to the original URL and increments click_count atomically.
- Analytics page shows total links, total clicks, top 5 links, and clicks over last 7 days (chart).
- Client and server input validation via Zod; all DB writes use parameterized queries.
- Rate limiting enforced: default 5 shorten requests/minute per IP.
- Project builds (pnpm/npm/yarn) and all included unit/integration tests run and pass.
- All sensitive values use environment variables; an .env.local.example is provided.
- Code is linted (ESLint) and formatted (Prettier) by included configs.
- A README with setup, local dev, deployment, and test instructions is included.

### TECHNICAL SPEC (what to generate)
- Framework: Next.js 14 (App Router)
- Language: TypeScript (strict)
- DB: Supabase (Postgres) — provide SQL for required tables and indexes
- Styling: Tailwind CSS + DaisyUI
- Forms: React Hook Form + Zod
- QR: qrcode (or qrcode.react) library
- Charts: Chart.js (React wrapper chartjs/react)
- Utilities: use Web Crypto API for secure ID generation
- Testing: Vitest + Testing Library for React + simple integration tests that mock Supabase
- Lint/Format: ESLint (recommended rules) + Prettier
- CI: GitHub Actions workflow to run lint, build, and tests

### DATABASE SCHEMA (provide exact SQL)
- table links:
  - id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
  - created_at TIMESTAMPTZ DEFAULT NOW()
  - original_url TEXT NOT NULL
  - short_id VARCHAR(10) NOT NULL UNIQUE
  - click_count INTEGER DEFAULT 0 NOT NULL
  - custom_alias BOOLEAN DEFAULT FALSE
  - last_accessed TIMESTAMPTZ
  - metadata JSONB DEFAULT '{}'::jsonb
- indexes:
  - UNIQUE INDEX on short_id
  - INDEX on created_at
  - INDEX on last_accessed

Include a statements block to create the table and indexes.

### FILES & FOLDER SCOPE (generate every file)
- Root: .env.local.example, .gitignore, package.json, pnpm-lock or yarn.lock optional, next.config.mjs, tsconfig.json, tailwind.config.ts, postcss.config.mjs, eslint.config.cjs, .prettierrc
- prisma/schema.prisma for local dev (optional) with a note it’s dev only
- lib/: supabase.ts, utils.ts, constants.ts, rateLimiter.ts
- app/: layout.tsx, page.tsx, analytics/page.tsx, not-found.tsx, [shortId]/page.tsx, api/shorten/route.ts, api/analytics/route.ts, api/links/route.ts, api/links/delete/route.ts
- components/: ui/button.tsx, ui/input.tsx, ui/toast.tsx, ui/table.tsx, url-form.tsx, link-table.tsx, qr-code.tsx, analytics-chart.tsx
- tests/: unit and integration tests
- scripts/: db-init.sql (create table), start scripts
- docs/: README.md, RUNBOOK.md (operational notes and troubleshooting)

### API CONTRACTS (explicit)
1. POST /api/shorten
   - Body: { url: string, customAlias?: string }
   - Responses:
     - 201: { shortUrl: string, shortId: string, qrDataUrl?: string }
     - 400: validation errors
     - 409: alias already exists
     - 429: rate limited
     - 500: server error
   - Behavior:
     - Validate URL with Zod + domain allowlist/denylist optional
     - If customAlias provided, validate pattern (alphanum, 6-10 chars), check uniqueness
     - If no alias, generate 6‑char secure random ID (URL safe)
     - Persist row using Supabase client with service_role key (server)
     - Return the fully qualified short URL using NEXT_PUBLIC_BASE_URL or construct from request
     - Emit lightweight audit log (insert into links.metadata->>events or console log)

2. GET /[shortId]
   - Behavior:
     - Lookup shortId parameter, if not found -> render custom 404
     - If found, perform atomic increment of click_count (UPDATE ... RETURNING) and set last_accessed = now()
     - Redirect with 302 or 307 to original_url
     - Log the click (insert into metadata JSONB field by upserting small event or increment aggregate)
   - Security:
     - Sanitize redirect URL; ensure it begins with http/https

3. GET /api/analytics
   - Returns aggregated data: totalLinks, totalClicks, top5 [{shortId, original_url, click_count}], clicksLast7Days [{date, count}]

4. GET /api/links
   - Returns full list of links (paginated) with server side sorting by created_at desc

5. DELETE /api/links/delete
   - Body: { shortId: string }
   - Behavior:
     - Delete the matching row; return 200 with deleted id or 404 if not found

### SECURITY & VALIDATION REQUIREMENTS
- Use Zod schemas for all request validation on server and client
- Use parameterized queries via Supabase client; avoid string interpolation
- Sanitize original_url; only allow http(s) protocols
- CORS: allow same origin; if enabling APIs for other origins, restrict to env allowlist
- Rate limit /api/shorten by IP: default 5/minute; document how to adjust
- No open redirects: confirm redirect URL is a fully qualified URL

### PERFORMANCE & UX NOTABLES
- No caching layer required
- Provide loading states and optimistic UI where appropriate
- Use react-virtualized or simple virtualization for large tables
- Use React.memo to avoid unnecessary re-renders
- Lazy load Chart.js and QR code generation on analytics and result display

### ACCESSIBILITY
- All buttons and inputs must have labels and ARIA attributes
- Keyboard accessible table rows and actions
- Focus management after actions (e.g., focus copy button after create)
- Contrast and semantic HTML

### TESTING
- Unit tests for utils (ID generation, URL validation)
- API tests (mock Supabase) for shorten, redirect and analytics
- Integration test: shorten -> GET short -> redirect simulated
- Add a sample vitest config and a GitHub Action to run tests
- Include sample test data seeding SQL in scripts/db-init.sql

### DOCUMENTATION TO INCLUDE (must be generated)
- README.md with:
  - Project description
  - Local setup steps (install, env variables, run dev, run tests)
  - Database initialization step (pSQL command using db-init.sql)
  - How to change rate limits and environment variables
  - Security notes and production checklist
- RUNBOOK.md with:
  - Debugging steps for common failures (Supabase connection, migrations)
  - Logging locations and what to search for
  - How to back up and restore the links table
  - Rollback instructions
- CODE_OF_CONDUCT.md (brief)

### DELIVERY FORMAT (strict)
- Output the entire project as a single continuous text block.
- For each file include a single leading comment line with the file path. Example:
// FILE: app/page.tsx
<complete file contents here>
- Every file must be syntactically complete and ready to write to disk.
- Do NOT include any additional explanation outside the generated files.

### QUALITY GATES (automated checks the agent must pass before returning output)
1. Project compiles (typecheck + next build) in theory (no runtime required for the agent).
2. All Zod schemas referenced in both client and server code exist and are exported from a shared file.
3. No use of uncontrolled string SQL concatenation.
4. No secrets are hardcoded; all secrets come from process.env.
5. All endpoints return typed responses (TypeScript types or interfaces).
6. Tests must be present and reference mockable Supabase client.

### EXAMPLES (for the agent to include in README)
- Example curl to shorten:
  curl -X POST -H "Content-Type: application/json" -d '{"url":"https://example.com","customAlias":"myalias"}' http://localhost:3000/api/shorten
- Example redirect:
  Visit http://localhost:3000/abc123 and be redirected to the original URL

### FINAL NOTES (strict)
- Keep the feature set limited to what’s described; do not add authentication, third‑party analytics, or caching.
- Where tradeoffs exist (e.g., in‑memory rate limiter vs production Redis), include a short comment in code and a note in RUNBOOK.md on how to upgrade.
- Favor explicitness and correctness over brevity. Provide clear inline JSDoc for utility functions and exported server handlers.
- Use NEXT_PUBLIC_BASE_URL when building absolute short URL strings; fallback to request.origin when absent.

Produce the full project now, meeting all the above constraints, acceptance criteria, and file structure. End of prompt.
```

--- 

### Short Design Rationale (1 paragraph)
This refined one‑shot prompt makes expectations explicit: prioritized goals, acceptance tests, security and validation rules, exact API contracts, DB schema, file list, test/CI requirements, and delivery format. That ensures a downstream coding agent can generate a complete, buildable project in a single response while remaining auditable and production‑focused.

---

https://copilot.microsoft.com/shares/HosJVhhC3DtZ4RtTafaQi

https://chat.z.ai/s/6e9af1f9-b5cc-4c02-aef1-0c8af9b1943e
